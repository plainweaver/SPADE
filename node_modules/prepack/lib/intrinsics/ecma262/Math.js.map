{"version":3,"sources":["../../../src/intrinsics/ecma262/Math.js"],"names":["buildMathTemplates","Map","realm","obj","ObjectValue","intrinsics","ObjectPrototype","defineNativeProperty","SymbolToStringTag","StringValue","writable","defineNativeConstant","NumberValue","functions","isCompatibleWith","MOBILE_JSC_VERSION","push","name","length","defineNativeMethod","context","args","originalLength","some","arg","AbstractValue","every","To","IsToNumberPure","templateSource","get","undefined","params","Placeholders","slice","join","set","createFromTemplate","Math","apply","map","i","ToNumber","throwIfNotConcrete","imulTemplateSrc","x","y","imul","ToUint32","mathRandomTemplateSrc","mathRandomGenerator","loc","currentLocation","error","CompilerDiagnostic","handleError","useAbstractInterpretation","createTemporalFromTemplate","isPure","skipInvariant","random"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport type { Realm } from \"../../realm.js\";\nimport { StringValue, ObjectValue, NumberValue, AbstractValue } from \"../../values/index.js\";\nimport { To } from \"../../singletons.js\";\nimport invariant from \"../../invariant.js\";\nimport { CompilerDiagnostic } from \"../../errors.js\";\nimport { Placeholders } from \"../../utils/PreludeGenerator.js\";\n\nlet buildMathTemplates: Map<string, string> = new Map();\n\nexport default function(realm: Realm): ObjectValue {\n  let obj = new ObjectValue(realm, realm.intrinsics.ObjectPrototype, \"Math\");\n\n  // ECMA262 20.2.1.9\n  obj.defineNativeProperty(realm.intrinsics.SymbolToStringTag, new StringValue(realm, \"Math\"), { writable: false });\n\n  // ECMA262 20.2.1.1\n  obj.defineNativeConstant(\"E\", new NumberValue(realm, 2.7182818284590452354));\n\n  // ECMA262 20.2.1.2\n  obj.defineNativeConstant(\"LN10\", new NumberValue(realm, 2.302585092994046));\n\n  // ECMA262 20.2.1.3\n  obj.defineNativeConstant(\"LN2\", new NumberValue(realm, 0.6931471805599453));\n\n  // ECMA262 20.2.1.4\n  obj.defineNativeConstant(\"LOG10E\", new NumberValue(realm, 0.4342944819032518));\n\n  // ECMA262 20.2.1.5\n  obj.defineNativeConstant(\"LOG2E\", new NumberValue(realm, 1.4426950408889634));\n\n  // ECMA262 20.2.1.6\n  obj.defineNativeConstant(\"PI\", new NumberValue(realm, 3.1415926535897932));\n\n  // ECMA262 20.2.1.7\n  obj.defineNativeConstant(\"SQRT1_2\", new NumberValue(realm, 0.7071067811865476));\n\n  // ECMA262 20.2.1.8\n  obj.defineNativeConstant(\"SQRT2\", new NumberValue(realm, 1.4142135623730951));\n\n  let functions = [\n    // ECMA262 20.2.2.1\n    [\"abs\", 1],\n\n    // ECMA262 20.2.2.2\n    [\"acos\", 1],\n\n    // ECMA262 20.2.2.3\n    [\"acosh\", 1],\n\n    // ECMA262 20.2.2.4\n    [\"asin\", 1],\n\n    // ECMA262 20.2.2.5\n    [\"asinh\", 1],\n\n    // ECMA262 20.2.2.6\n    [\"atan\", 1],\n\n    // ECMA262 20.2.2.7\n    [\"atanh\", 1],\n\n    // ECMA262 20.2.2.8\n    [\"atan2\", 2],\n\n    // ECMA262 20.2.2.9\n    [\"cbrt\", 1],\n\n    // ECMA262 20.2.2.10\n    [\"ceil\", 1],\n\n    // ECMA262 20.2.2.12\n    [\"cos\", 1],\n\n    // ECMA262 20.2.2.13\n    [\"cosh\", 1],\n\n    // ECMA262 20.2.2.14\n    [\"exp\", 1],\n\n    // ECMA262 20.2.2.15\n    [\"expm1\", 1],\n\n    // ECMA262 20.2.2.16\n    [\"floor\", 1],\n\n    // ECMA262 20.2.2.17\n    [\"fround\", 1],\n\n    // ECMA262 20.2.2.18\n    [\"hypot\", 2],\n\n    // ECMA262 20.2.2.20\n    [\"log\", 1],\n\n    // ECMA262 20.2.2.21\n    [\"log1p\", 1],\n\n    // ECMA262 20.2.2.22\n    [\"log10\", 1],\n\n    // ECMA262 20.2.2.23\n    [\"log2\", 1],\n\n    // ECMA262 20.2.2.24 ( _value1_, _value2_, ..._values_ )\n    [\"max\", 2],\n\n    // ECMA262 20.2.2.25\n    [\"min\", 2],\n\n    // ECMA262 20.2.2.26\n    [\"pow\", 2],\n\n    // ECMA262 20.2.2.28\n    [\"round\", 1],\n\n    // ECMA262 20.2.2.30\n    [\"sin\", 1],\n\n    // ECMA262 20.2.2.31\n    [\"sinh\", 1],\n\n    // ECMA262 20.2.2.32\n    [\"sqrt\", 1],\n\n    // ECMA262 20.2.2.33\n    [\"tan\", 1],\n\n    // ECMA262 20.2.2.34\n    [\"tanh\", 1],\n\n    // ECMA262 20.2.2.35\n    [\"trunc\", 1],\n  ];\n\n  // ECMA262 20.2.2.11\n  if (!realm.isCompatibleWith(realm.MOBILE_JSC_VERSION) && !realm.isCompatibleWith(\"mobile\"))\n    functions.push([\"clz32\", 1]);\n\n  // ECMA262 20.2.2.29 (_x_)\n  if (!realm.isCompatibleWith(realm.MOBILE_JSC_VERSION) && !realm.isCompatibleWith(\"mobile\"))\n    functions.push([\"sign\", 1]);\n\n  for (let [name, length] of functions) {\n    obj.defineNativeMethod(name, length, (context, args, originalLength) => {\n      invariant(originalLength >= 0);\n      args.length = originalLength;\n      if (\n        originalLength <= 26 &&\n        args.some(arg => arg instanceof AbstractValue) &&\n        args.every(arg => To.IsToNumberPure(realm, arg))\n      ) {\n        let templateSource = buildMathTemplates.get(name);\n        if (templateSource === undefined) {\n          let params = Placeholders.slice(0, originalLength).join(\",\");\n          templateSource = `global.Math.${name}(${params})`;\n          buildMathTemplates.set(name, templateSource);\n        }\n        return AbstractValue.createFromTemplate(realm, templateSource, NumberValue, args);\n      }\n\n      return new NumberValue(\n        realm,\n        Math[name].apply(null, args.map((arg, i) => To.ToNumber(realm, arg.throwIfNotConcrete())))\n      );\n    });\n  }\n\n  const imulTemplateSrc = \"global.Math.imul(A, B)\";\n\n  // ECMA262 20.2.2.19\n  obj.defineNativeMethod(\"imul\", 2, (context, [x, y]) => {\n    if (\n      (x instanceof AbstractValue || y instanceof AbstractValue) &&\n      To.IsToNumberPure(realm, x) &&\n      To.IsToNumberPure(realm, y)\n    ) {\n      return AbstractValue.createFromTemplate(realm, imulTemplateSrc, NumberValue, [x, y]);\n    }\n\n    return new NumberValue(\n      realm,\n      Math.imul(To.ToUint32(realm, x.throwIfNotConcrete()), To.ToUint32(realm, y.throwIfNotConcrete()))\n    );\n  });\n\n  const mathRandomTemplateSrc = \"global.Math.random()\";\n\n  // ECMA262 20.2.2.27\n  obj.defineNativeMethod(\"random\", 0, context => {\n    let mathRandomGenerator = realm.mathRandomGenerator;\n    if (mathRandomGenerator !== undefined) {\n      let loc = realm.currentLocation;\n      let error = new CompilerDiagnostic(\n        \"Result of Math.random() is made deterministic via a fixed mathRandomSeed\",\n        loc,\n        \"PP8000\",\n        \"Information\"\n      );\n      realm.handleError(error);\n\n      return new NumberValue(realm, mathRandomGenerator());\n    } else if (realm.useAbstractInterpretation) {\n      return AbstractValue.createTemporalFromTemplate(realm, mathRandomTemplateSrc, NumberValue, [], {\n        isPure: true,\n        skipInvariant: true,\n      });\n    } else {\n      return new NumberValue(realm, Math.random());\n    }\n  });\n\n  return obj;\n}\n"],"file":"Math.js"}