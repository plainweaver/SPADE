{"version":3,"sources":["../src/utils.js"],"names":["typeToString","type","isInstance","proto","Constructor","prototype","UndefinedValue","NullValue","StringValue","BooleanValue","NumberValue","SymbolValue","ObjectValue","Value","isTypeCompatibleWith","FunctionValue","undefined","getTypeFromName","typeName","EmptyValue","ArrayValue","IntegralValue","describeValue","value","title","suffix","PrimitiveValue","toDisplayString","AbstractValue","constructor","name","kind","arg","args","desc","split","map","u","join","getHash","intrinsicName","__originalName","jsonToDisplayString","instance","depth","result","toDisplayJson","JSON","stringify","replace","verboseToDisplayJson","obj","valueOfProp","prop","Array","isArray","length","valuesArray","x","string","reduce","acc","Object","Set","Map","size","toJSON","toString","key","createModelledFunctionCall","realm","funcValue","argModelInput","thisValue","call","$Call","numArgs","getLength","argModel","parse","ECMAScriptSourceFunctionValue","params","$FormalParameters","parameterId","t","isIdentifier","paramName","shape","ShapeInformation","createForArgument","push","createAbstractArgument","expressionLocation","getAbstractType","handleError","CompilerDiagnostic","FatalError","thisArg","savedPathConditions","pathConditions","newPathConditions","pathConditionDuringDeclaration"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow strict-local */\n\nimport type { Realm } from \"./realm.js\";\nimport {\n  AbstractValue,\n  ArrayValue,\n  BooleanValue,\n  ECMAScriptSourceFunctionValue,\n  EmptyValue,\n  FunctionValue,\n  NullValue,\n  NumberValue,\n  IntegralValue,\n  ObjectValue,\n  StringValue,\n  SymbolValue,\n  UndefinedValue,\n  PrimitiveValue,\n  Value,\n} from \"./values/index.js\";\nimport invariant from \"./invariant.js\";\nimport { ShapeInformation } from \"./utils/ShapeInformation.js\";\nimport type { ArgModel } from \"./types.js\";\nimport { CompilerDiagnostic, FatalError } from \"./errors.js\";\nimport * as t from \"@babel/types\";\n\nexport function typeToString(type: typeof Value): void | string {\n  function isInstance(proto, Constructor): boolean {\n    return proto instanceof Constructor || proto === Constructor.prototype;\n  }\n  let proto = type.prototype;\n  if (isInstance(proto, UndefinedValue)) {\n    return \"undefined\";\n  } else if (isInstance(proto, NullValue)) {\n    return \"object\";\n  } else if (isInstance(proto, StringValue)) {\n    return \"string\";\n  } else if (isInstance(proto, BooleanValue)) {\n    return \"boolean\";\n  } else if (isInstance(proto, NumberValue)) {\n    return \"number\";\n  } else if (isInstance(proto, SymbolValue)) {\n    return \"symbol\";\n  } else if (isInstance(proto, ObjectValue)) {\n    if (Value.isTypeCompatibleWith(type, FunctionValue)) {\n      return \"function\";\n    }\n    return \"object\";\n  } else {\n    return undefined;\n  }\n}\n\nexport function getTypeFromName(typeName: string): void | typeof Value {\n  switch (typeName) {\n    case \"empty\":\n      return EmptyValue;\n    case \"void\":\n      return UndefinedValue;\n    case \"null\":\n      return NullValue;\n    case \"boolean\":\n      return BooleanValue;\n    case \"string\":\n      return StringValue;\n    case \"symbol\":\n      return SymbolValue;\n    case \"number\":\n      return NumberValue;\n    case \"object\":\n      return ObjectValue;\n    case \"array\":\n      return ArrayValue;\n    case \"function\":\n      return FunctionValue;\n    case \"integral\":\n      return IntegralValue;\n    default:\n      return undefined;\n  }\n}\n\nexport function describeValue(value: Value): string {\n  let title;\n  let suffix = \"\";\n  if (value instanceof PrimitiveValue) title = value.toDisplayString();\n  else if (value instanceof ObjectValue) title = \"[object]\";\n  else {\n    invariant(value instanceof AbstractValue, value.constructor.name);\n    title = \"[abstract]\";\n    if (value.kind !== undefined) title += `, kind: ${value.kind}`;\n    for (let arg of value.args) {\n      let desc = describeValue(arg);\n      suffix +=\n        desc\n          .split(\"\\n\")\n          .map(u => \"  \" + u)\n          .join(\"\\n\") + \"\\n\";\n    }\n  }\n  title += `, hash: ${value.getHash()}`;\n  if (value.intrinsicName !== undefined) title += `, intrinsic name: ${value.intrinsicName}`;\n  if (value.__originalName !== undefined) title += `, original name: ${value.__originalName}`;\n  return suffix ? `${title}\\n${suffix}` : title;\n}\n\ntype DisplayResult = {} | string;\n\nexport function jsonToDisplayString<T: { toDisplayJson(number): DisplayResult }>(instance: T, depth: number): string {\n  let result = instance.toDisplayJson(depth);\n  return typeof result === \"string\" ? result : JSON.stringify(result, null, 2).replace(/\\\"/g, \"\");\n}\n\nexport function verboseToDisplayJson(obj: {}, depth: number): DisplayResult {\n  let result = {};\n  function valueOfProp(prop) {\n    if (typeof prop === \"function\") return undefined;\n    if (Array.isArray(prop)) {\n      // Try to return a 1-line string if possible\n      if (prop.length === 0) return \"[]\";\n      let valuesArray = prop.map(x => valueOfProp(x));\n      if (valuesArray.length < 5) {\n        let string =\n          \"[\" + valuesArray.reduce((acc, x) => `${acc}, ${x instanceof Object ? JSON.stringify(x) : x}`) + \"]\";\n        string = string.replace(/\\\"/g, \"\");\n        if (string.length < 60) return string;\n      }\n      return valuesArray;\n    }\n    if (prop instanceof Set || prop instanceof Map) return `${prop.constructor.name}(${prop.size})`;\n    if (prop.toDisplayJson) return prop.toDisplayJson(depth - 1);\n    if (prop.toDisplayString) return prop.toDisplayString();\n    if (prop.toJSON) return prop.toJSON();\n    return prop.toString();\n  }\n  for (let key in obj) {\n    let prop = obj[key];\n    if (!prop) continue;\n    let value = valueOfProp(prop);\n    if (value !== undefined && value !== \"[object Object]\") result[key] = value;\n  }\n  return result;\n}\n\nexport function createModelledFunctionCall(\n  realm: Realm,\n  funcValue: FunctionValue,\n  argModelInput: void | string | ArgModel,\n  thisValue: void | Value\n): void => Value {\n  let call = funcValue.$Call;\n  invariant(call);\n  let numArgs = funcValue.getLength();\n  let args = [];\n  let argModel = typeof argModelInput === \"string\" ? (JSON.parse(argModelInput): ArgModel) : argModelInput;\n  invariant(funcValue instanceof ECMAScriptSourceFunctionValue);\n  let params = funcValue.$FormalParameters;\n  if (numArgs !== undefined && numArgs > 0 && params) {\n    for (let parameterId of params) {\n      if (t.isIdentifier(parameterId)) {\n        // $FlowFixMe: Flow strict file does not allow for casting\n        let paramName = ((parameterId: any): BabelNodeIdentifier).name;\n        let shape = ShapeInformation.createForArgument(argModel, paramName);\n        // Create an AbstractValue similar to __abstract being called\n        args.push(\n          AbstractValue.createAbstractArgument(\n            realm,\n            paramName,\n            funcValue.expressionLocation,\n            shape !== undefined ? shape.getAbstractType() : Value,\n            shape\n          )\n        );\n      } else {\n        realm.handleError(\n          new CompilerDiagnostic(\n            \"Non-identifier args to additional functions unsupported\",\n            funcValue.expressionLocation,\n            \"PP1005\",\n            \"FatalError\"\n          )\n        );\n        throw new FatalError(\"Non-identifier args to additional functions unsupported\");\n      }\n    }\n  }\n  let thisArg =\n    thisValue !== undefined\n      ? thisValue\n      : AbstractValue.createAbstractArgument(realm, \"this\", funcValue.expressionLocation, ObjectValue);\n  return () => {\n    let savedPathConditions = realm.pathConditions;\n    let newPathConditions = funcValue.pathConditionDuringDeclaration || savedPathConditions;\n    realm.pathConditions = newPathConditions;\n    try {\n      let result = call(thisArg, args);\n      return result;\n    } finally {\n      realm.pathConditions = savedPathConditions;\n    }\n  };\n}\n"],"file":"utils.js"}