{"version":3,"sources":["../../src/serializer/LazyObjectsSerializer.js"],"names":["LAZY_OBJECTS_SERIALIZER_BODY_TYPE","LazyObjectsSerializer","ResidualHeapSerializer","constructor","realm","logger","modules","residualHeapValueIdentifiers","residualHeapInspector","residualHeapInfo","options","additionalFunctionValuesAndEffects","referentializer","generatorTree","residualOptimizedFunctions","_lazyObjectIdSeed","_valueLazyIds","Map","_lazyObjectInitializers","_callbackLazyObjectParam","t","identifier","_options","lazyObjectsRuntime","_lazyObjectJSRuntimeName","_initializationCallbackName","_getValueLazyId","obj","_serializeLazyObjectInitializer","emitIntegrityCommand","initializerBody","type","parentBody","undefined","entries","done","oldBody","emitter","beginEmitting","_emitObjectProperties","getBody","endEmitting","_serializeLazyObjectInitializerSwitchCase","initializer","caseBody","concat","breakStatement","lazyId","switchCase","numericLiteral","_serializeInitializationCallback","body","switchCases","push","throwStatement","newExpression","stringLiteral","selector","switchStatement","params","initializerCallbackFunction","functionExpression","blockStatement","variableDeclaration","variableDeclarator","_serializeRegisterInitializationCallback","expressionStatement","callExpression","memberExpression","_serializeCreateLazyObject","_isEmittingIntoLazyObjectInitializerBody","objLazyBody","get","isCurrentBodyOffspringOf","getSerializeObjectIdentifier","val","ObjectValue","serializeValueRawObject","skipPrototype","temporalAlias","set","postGeneratorSerialization","size","prelude"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow strict-local */\n\nimport { Realm } from \"../realm.js\";\nimport { FunctionValue, Value, ObjectValue } from \"../values/index.js\";\nimport * as t from \"@babel/types\";\nimport type { BabelNodeExpression, BabelNodeStatement, BabelNodeIdentifier, BabelNodeSwitchCase } from \"@babel/types\";\nimport type { SerializedBody, AdditionalFunctionEffects, ResidualHeapInfo } from \"./types.js\";\nimport type { SerializerOptions } from \"../options.js\";\nimport invariant from \"../invariant.js\";\nimport { Logger } from \"../utils/logger.js\";\nimport { Modules } from \"../utils/modules.js\";\nimport { HeapInspector } from \"../utils/HeapInspector.js\";\nimport { ResidualHeapValueIdentifiers } from \"./ResidualHeapValueIdentifiers.js\";\nimport { ResidualHeapSerializer } from \"./ResidualHeapSerializer.js\";\nimport { getOrDefault } from \"./utils.js\";\nimport type { ResidualOptimizedFunctions } from \"./ResidualOptimizedFunctions\";\nimport type { Referentializer } from \"./Referentializer.js\";\nimport { GeneratorTree } from \"./GeneratorTree.js\";\n\nconst LAZY_OBJECTS_SERIALIZER_BODY_TYPE = \"LazyObjectInitializer\";\n\n/**\n * Serialize objects in lazy mode by leveraging the JS runtime that support this feature.\n * Objects are serialized into two parts:\n * 1. All lazy objects are created via lightweight LazyObjectsRuntime.createLazyObject() call.\n * 2. Lazy objects' property assignments are delayed in a callback function which is registered with the runtime.\n *    lazy objects runtime will execute this callback to hydrate the lazy objects.\n *\n * Currently only the raw objects are taking part in the lazy objects feature.\n * TODO: support for other objects, like array, regex etc...\n */\nexport class LazyObjectsSerializer extends ResidualHeapSerializer {\n  constructor(\n    realm: Realm,\n    logger: Logger,\n    modules: Modules,\n    residualHeapValueIdentifiers: ResidualHeapValueIdentifiers,\n    residualHeapInspector: HeapInspector,\n    residualHeapInfo: ResidualHeapInfo,\n    options: SerializerOptions,\n    additionalFunctionValuesAndEffects: Map<FunctionValue, AdditionalFunctionEffects>,\n    referentializer: Referentializer,\n    generatorTree: GeneratorTree,\n    residualOptimizedFunctions: ResidualOptimizedFunctions\n  ) {\n    super(\n      realm,\n      logger,\n      modules,\n      residualHeapValueIdentifiers,\n      residualHeapInspector,\n      residualHeapInfo,\n      options,\n      additionalFunctionValuesAndEffects,\n      referentializer,\n      generatorTree,\n      residualOptimizedFunctions\n    );\n\n    this._lazyObjectIdSeed = 1;\n    this._valueLazyIds = new Map();\n    this._lazyObjectInitializers = new Map();\n    this._callbackLazyObjectParam = t.identifier(\"obj\");\n    invariant(this._options.lazyObjectsRuntime != null);\n    this._lazyObjectJSRuntimeName = t.identifier(this._options.lazyObjectsRuntime);\n    this._initializationCallbackName = t.identifier(\"__initializerCallback\");\n  }\n\n  _lazyObjectIdSeed: number;\n  _valueLazyIds: Map<ObjectValue, number>;\n  // Holds object's lazy initializer bodies.\n  // These bodies will be combined into a well-known callback after generator serialization is done and registered with the runtime.\n  _lazyObjectInitializers: Map<ObjectValue, SerializedBody>;\n\n  _lazyObjectJSRuntimeName: BabelNodeIdentifier;\n  _callbackLazyObjectParam: BabelNodeIdentifier;\n  _initializationCallbackName: BabelNodeIdentifier;\n\n  _getValueLazyId(obj: ObjectValue): number {\n    return getOrDefault(this._valueLazyIds, obj, () => this._lazyObjectIdSeed++);\n  }\n\n  // TODO: change to use _getTarget() to get the lazy objects initializer body.\n  _serializeLazyObjectInitializer(\n    obj: ObjectValue,\n    emitIntegrityCommand: void | (SerializedBody => void)\n  ): SerializedBody {\n    const initializerBody = {\n      type: LAZY_OBJECTS_SERIALIZER_BODY_TYPE,\n      parentBody: undefined,\n      entries: [],\n      done: false,\n    };\n    let oldBody = this.emitter.beginEmitting(LAZY_OBJECTS_SERIALIZER_BODY_TYPE, initializerBody);\n    this._emitObjectProperties(obj);\n    if (emitIntegrityCommand !== undefined) emitIntegrityCommand(this.emitter.getBody());\n    this.emitter.endEmitting(LAZY_OBJECTS_SERIALIZER_BODY_TYPE, oldBody);\n    return initializerBody;\n  }\n\n  _serializeLazyObjectInitializerSwitchCase(obj: ObjectValue, initializer: SerializedBody): BabelNodeSwitchCase {\n    // TODO: only serialize this switch case if the initializer(property assignment) is not empty.\n    const caseBody = initializer.entries.concat(t.breakStatement());\n    const lazyId = this._getValueLazyId(obj);\n    return t.switchCase(t.numericLiteral(lazyId), caseBody);\n  }\n\n  _serializeInitializationCallback(): BabelNodeStatement {\n    const body = [];\n\n    const switchCases = [];\n    for (const [obj, initializer] of this._lazyObjectInitializers) {\n      switchCases.push(this._serializeLazyObjectInitializerSwitchCase(obj, initializer));\n    }\n    // Default case.\n    switchCases.push(\n      t.switchCase(null, [\n        t.throwStatement(t.newExpression(t.identifier(\"Error\"), [t.stringLiteral(\"Unknown lazy id\")])),\n      ])\n    );\n\n    const selector = t.identifier(\"id\");\n    body.push(t.switchStatement(selector, switchCases));\n\n    const params = [this._callbackLazyObjectParam, selector];\n    const initializerCallbackFunction = t.functionExpression(null, params, t.blockStatement(body));\n    // TODO: use NameGenerator.\n    return t.variableDeclaration(\"var\", [\n      t.variableDeclarator(this._initializationCallbackName, initializerCallbackFunction),\n    ]);\n  }\n\n  _serializeRegisterInitializationCallback(): BabelNodeStatement {\n    return t.expressionStatement(\n      t.callExpression(t.memberExpression(this._lazyObjectJSRuntimeName, t.identifier(\"setLazyObjectInitializer\")), [\n        this._initializationCallbackName,\n      ])\n    );\n  }\n\n  _serializeCreateLazyObject(obj: ObjectValue): BabelNodeExpression {\n    const lazyId = this._getValueLazyId(obj);\n    return t.callExpression(\n      t.memberExpression(this._lazyObjectJSRuntimeName, t.identifier(\"createLazyObject\"), /*computed*/ false),\n      [t.numericLiteral(lazyId)]\n    );\n  }\n\n  /**\n   * Check if the object currently being emitted is lazy object(inside _lazyObjectInitializers map) and\n   * that its emitting body is the offspring of this lazy object's initializer body.\n   * This is needed because for \"lazy1.p = lazy2\" case,\n   * we need to replace \"lazy1\" with \"obj\" but not for \"lazy2\".\n   * The offspring checking is needed because object may be emitting in a \"ConditionalAssignmentBranch\" of\n   * lazy object's initializer body.\n   */\n  _isEmittingIntoLazyObjectInitializerBody(obj: ObjectValue): boolean {\n    const objLazyBody = this._lazyObjectInitializers.get(obj);\n    return objLazyBody !== undefined && this.emitter.isCurrentBodyOffspringOf(objLazyBody);\n  }\n\n  // Override default behavior.\n  // Inside lazy objects callback, the lazy object identifier needs to be replaced with the\n  // parameter passed from the runtime.\n  getSerializeObjectIdentifier(val: Value): BabelNodeIdentifier {\n    return val instanceof ObjectValue && this._isEmittingIntoLazyObjectInitializerBody(val)\n      ? this._callbackLazyObjectParam\n      : super.getSerializeObjectIdentifier(val);\n  }\n\n  // Override default serializer with lazy mode.\n  serializeValueRawObject(\n    obj: ObjectValue,\n    skipPrototype: boolean,\n    emitIntegrityCommand: void | (SerializedBody => void)\n  ): BabelNodeExpression {\n    if (obj.temporalAlias !== undefined) return super.serializeValueRawObject(obj, skipPrototype, emitIntegrityCommand);\n    this._lazyObjectInitializers.set(obj, this._serializeLazyObjectInitializer(obj, emitIntegrityCommand));\n    return this._serializeCreateLazyObject(obj);\n  }\n\n  // Override.\n  // Serialize the initialization callback and its registration in prelude if there are object being lazied.\n  postGeneratorSerialization(): void {\n    if (this._lazyObjectInitializers.size > 0) {\n      // Insert initialization callback at the end of prelude code.\n      this.prelude.push(this._serializeInitializationCallback());\n      this.prelude.push(this._serializeRegisterInitializationCallback());\n    }\n  }\n}\n"],"file":"LazyObjectsSerializer.js"}