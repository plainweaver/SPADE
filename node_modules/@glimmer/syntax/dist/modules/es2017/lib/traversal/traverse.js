import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
import { deprecate } from '@glimmer/util';

import Path from './path';
function getEnterFunction(handler) {
    if (typeof handler === 'function') {
        return handler;
    } else {
        return handler.enter;
    }
}
function getExitFunction(handler) {
    if (typeof handler === 'function') {
        return undefined;
    } else {
        return handler.exit;
    }
}
function getKeyHandler(handler, key) {
    let keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    let keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    if (nodeType === 'Template' || nodeType === 'Block') {
        if (visitor.Program) {
            if (false) {
                (false && !(false) && deprecate(`TODO`));
            }
            return visitor.Program;
        }
    }
    let handler = visitor[nodeType];
    if (handler !== undefined) {
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, path) {
    let { node, parent, parentKey } = path;
    let handler = getNodeHandler(visitor, node.type);
    let enter;
    let exit;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    let result;
    if (enter !== undefined) {
        result = enter(node, path);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            visitArray(visitor, result, parent, parentKey);
            return result;
        } else {
            let path = new Path(result, parent, parentKey);
            return visitNode(visitor, path) || result;
        }
    }
    if (result === undefined) {
        let keys = visitorKeys[node.type];
        for (let i = 0; i < keys.length; i++) {
            let key = keys[i];
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, path, key);
        }
        if (exit !== undefined) {
            result = exit(node, path);
        }
    }
    return result;
}
function get(node, key) {
    return node[key];
}
function set(node, key, value) {
    node[key] = value;
}
function visitKey(visitor, handler, path, key) {
    let { node } = path;
    let value = get(node, key);
    if (!value) {
        return;
    }
    let keyEnter;
    let keyExit;
    if (handler !== undefined) {
        let keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value, path, key);
    } else {
        let keyPath = new Path(value, path, key);
        let result = visitNode(visitor, keyPath);
        if (result !== undefined) {
            // TODO: dynamically check the results by having a table of
            // expected node types in value space, not just type space
            assignKey(node, key, value, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array, parent, parentKey) {
    for (let i = 0; i < array.length; i++) {
        let node = array[i];
        let path = new Path(node, parent, parentKey);
        let result = visitNode(visitor, path);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, value, result) {
    if (result === null) {
        throw cannotRemoveNode(value, node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            set(node, key, result[0]);
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(value, node, key);
            } else {
                throw cannotReplaceNode(value, node, key);
            }
        }
    } else {
        set(node, key, result);
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice(index, 1, ...result);
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    let path = new Path(node);
    visitNode(visitor, path);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sV0FBUCxNQUFxRCx1QkFBckQ7QUFDQSxTQUNFLGdCQURGLEVBRUUsaUJBRkYsRUFHRSxvQ0FIRixRQUlPLFVBSlA7QUFNQSxTQUFTLFNBQVQsUUFBMEIsZUFBMUI7O0FBR0EsT0FBTyxJQUFQLE1BQWlCLFFBQWpCO0FBUUEsU0FBUyxnQkFBVCxDQUNFLE9BREYsRUFDZ0Q7QUFFOUMsUUFBSSxPQUFPLE9BQVAsS0FBbUIsVUFBdkIsRUFBbUM7QUFDakMsZUFBTyxPQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsZUFBTyxRQUFRLEtBQWY7QUFDRDtBQUNGO0FBTUQsU0FBUyxlQUFULENBQ0UsT0FERixFQUNnRDtBQUU5QyxRQUFJLE9BQU8sT0FBUCxLQUFtQixVQUF2QixFQUFtQztBQUNqQyxlQUFPLFNBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxlQUFPLFFBQVEsSUFBZjtBQUNEO0FBQ0Y7QUFFRCxTQUFTLGFBQVQsQ0FDRSxPQURGLEVBRUUsR0FGRixFQUVRO0FBRU4sUUFBSSxhQUFhLE9BQU8sT0FBUCxLQUFtQixVQUFuQixHQUFnQyxRQUFRLElBQXhDLEdBQStDLFNBQWhFO0FBQ0EsUUFBSSxlQUFlLFNBQW5CLEVBQThCO0FBRTlCLFFBQUksYUFBYSxXQUFXLEdBQVgsQ0FBakI7QUFDQSxRQUFJLGVBQWUsU0FBbkIsRUFBOEI7QUFDNUIsZUFBTyxVQUFQO0FBQ0Q7QUFDRCxXQUFPLFdBQVcsR0FBbEI7QUFDRDtBQU9ELFNBQVMsY0FBVCxDQUNFLE9BREYsRUFFRSxRQUZGLEVBRXFCO0FBRW5CLFFBQUksYUFBYSxVQUFiLElBQTJCLGFBQWEsT0FBNUMsRUFBcUQ7QUFDbkQsWUFBSSxRQUFRLE9BQVosRUFBcUI7QUFDbkIsdUJBQWE7QUFBQSxzQ0FDWCxVQUFVLE1BQVYsQ0FEVztB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SUFBVCxDQUFYO0FBQ0EsY0FBVSxPQUFWLEVBQW1CLElBQW5CO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdmlzaXRvcktleXMsIHsgVmlzaXRvcktleXMsIFZpc2l0b3JLZXkgfSBmcm9tICcuLi90eXBlcy92aXNpdG9yLWtleXMnO1xuaW1wb3J0IHtcbiAgY2Fubm90UmVtb3ZlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldCxcbn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0ICogYXMgQVNUIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IGRlcHJlY2F0ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgREVWTU9ERSB9IGZyb20gJ0BnbGltbWVyL2xvY2FsLWRlYnVnLWZsYWdzJztcbmltcG9ydCB7IE5vZGVIYW5kbGVyLCBOb2RlVmlzaXRvciwgS2V5SGFuZGxlciwgTm9kZVRyYXZlcnNhbCwgS2V5VHJhdmVyc2FsIH0gZnJvbSAnLi92aXNpdG9yJztcbmltcG9ydCBQYXRoIGZyb20gJy4vcGF0aCc7XG5cbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPlxuKTogTm9kZUhhbmRsZXI8Tj4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+IHwgS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gaGFuZGxlcjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlci5lbnRlciBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZT4oaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPik6IE5vZGVIYW5kbGVyPE4+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gfCBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZCB7XG4gIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGhhbmRsZXIuZXhpdCBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0S2V5SGFuZGxlcjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPixcbiAga2V5OiBLXG4pOiBLZXlUcmF2ZXJzYWw8TiwgSz4gfCBLZXlUcmF2ZXJzYWw8TiwgVmlzaXRvcktleTxOPj4gfCB1bmRlZmluZWQge1xuICBsZXQga2V5VmlzaXRvciA9IHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nID8gaGFuZGxlci5rZXlzIDogdW5kZWZpbmVkO1xuICBpZiAoa2V5VmlzaXRvciA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG5cbiAgbGV0IGtleUhhbmRsZXIgPSBrZXlWaXNpdG9yW2tleV07XG4gIGlmIChrZXlIYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4ga2V5SGFuZGxlciBhcyBLZXlUcmF2ZXJzYWw8TiwgSz47XG4gIH1cbiAgcmV0dXJuIGtleVZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcjxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICB2aXNpdG9yOiBOb2RlVmlzaXRvcixcbiAgbm9kZVR5cGU6IE5bJ3R5cGUnXVxuKTogTm9kZVRyYXZlcnNhbDxOPjtcbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlVHlwZTogJ0FsbCcpOiBOb2RlVHJhdmVyc2FsPEFTVC5Ob2RlPjtcbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyPE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBub2RlVHlwZTogTlsndHlwZSddXG4pOiBOb2RlVHJhdmVyc2FsPE4+IHwgTm9kZVRyYXZlcnNhbDxBU1QuTm9kZT4gfCB1bmRlZmluZWQge1xuICBpZiAobm9kZVR5cGUgPT09ICdUZW1wbGF0ZScgfHwgbm9kZVR5cGUgPT09ICdCbG9jaycpIHtcbiAgICBpZiAodmlzaXRvci5Qcm9ncmFtKSB7XG4gICAgICBpZiAoREVWTU9ERSkge1xuICAgICAgICBkZXByZWNhdGUoYFRPRE9gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHZpc2l0b3IuUHJvZ3JhbSBhcyBhbnk7XG4gICAgfVxuICB9XG5cbiAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW25vZGVUeXBlXTtcbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiAoaGFuZGxlciBhcyB1bmtub3duKSBhcyBOb2RlVHJhdmVyc2FsPE4+O1xuICB9XG4gIHJldHVybiB2aXNpdG9yLkFsbDtcbn1cblxuZnVuY3Rpb24gdmlzaXROb2RlPE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBwYXRoOiBQYXRoPE4+XG4pOiBBU1QuTm9kZSB8IEFTVC5Ob2RlW10gfCB1bmRlZmluZWQgfCBudWxsIHwgdm9pZCB7XG4gIGxldCB7IG5vZGUsIHBhcmVudCwgcGFyZW50S2V5IH0gPSBwYXRoO1xuXG4gIGxldCBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+ID0gZ2V0Tm9kZUhhbmRsZXIodmlzaXRvciwgbm9kZS50eXBlKTtcbiAgbGV0IGVudGVyO1xuICBsZXQgZXhpdDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgZW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGhhbmRsZXIpO1xuICAgIGV4aXQgPSBnZXRFeGl0RnVuY3Rpb24oaGFuZGxlcik7XG4gIH1cblxuICBsZXQgcmVzdWx0OiBBU1QuTm9kZSB8IEFTVC5Ob2RlW10gfCB1bmRlZmluZWQgfCBudWxsIHwgdm9pZDtcbiAgaWYgKGVudGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXN1bHQgPSBlbnRlcihub2RlLCBwYXRoKTtcbiAgfVxuXG4gIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCAmJiByZXN1bHQgIT09IG51bGwpIHtcbiAgICBpZiAoSlNPTi5zdHJpbmdpZnkobm9kZSkgPT09IEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpIHtcbiAgICAgIHJlc3VsdCA9IHVuZGVmaW5lZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgdmlzaXRBcnJheSh2aXNpdG9yLCByZXN1bHQsIHBhcmVudCwgcGFyZW50S2V5KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBwYXRoID0gbmV3IFBhdGgocmVzdWx0LCBwYXJlbnQsIHBhcmVudEtleSk7XG4gICAgICByZXR1cm4gdmlzaXROb2RlKHZpc2l0b3IsIHBhdGgpIHx8IHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5cyA9IHZpc2l0b3JLZXlzW25vZGUudHlwZV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBrZXkgPSBrZXlzW2ldIGFzIFZpc2l0b3JLZXlzW05bJ3R5cGUnXV0gJiBrZXlvZiBOO1xuICAgICAgLy8gd2Uga25vdyBpZiBpdCBoYXMgY2hpbGQga2V5cyB3ZSBjYW4gd2lkZW4gdG8gYSBQYXJlbnROb2RlXG4gICAgICB2aXNpdEtleSh2aXNpdG9yLCBoYW5kbGVyLCBwYXRoLCBrZXkpO1xuICAgIH1cblxuICAgIGlmIChleGl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlc3VsdCA9IGV4aXQobm9kZSwgcGF0aCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gZ2V0PE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIG5vZGU6IE4sXG4gIGtleTogVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE5cbik6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB7XG4gIHJldHVybiAobm9kZVtrZXldIGFzIHVua25vd24pIGFzIEFTVC5Ob2RlIHwgQVNULk5vZGVbXTtcbn1cblxuZnVuY3Rpb24gc2V0PE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIGtleW9mIE4+KG5vZGU6IE4sIGtleTogSywgdmFsdWU6IE5bS10pOiB2b2lkIHtcbiAgbm9kZVtrZXldID0gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIHZpc2l0S2V5PE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+LFxuICBwYXRoOiBQYXRoPE4+LFxuICBrZXk6IFZpc2l0b3JLZXlzW05bJ3R5cGUnXV0gJiBrZXlvZiBOXG4pIHtcbiAgbGV0IHsgbm9kZSB9ID0gcGF0aDtcblxuICBsZXQgdmFsdWUgPSBnZXQobm9kZSwga2V5KTtcbiAgaWYgKCF2YWx1ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBrZXlFbnRlcjtcbiAgbGV0IGtleUV4aXQ7XG5cbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlIYW5kbGVyID0gZ2V0S2V5SGFuZGxlcihoYW5kbGVyLCBrZXkpO1xuICAgIGlmIChrZXlIYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGtleUVudGVyID0gZ2V0RW50ZXJGdW5jdGlvbihrZXlIYW5kbGVyKTtcbiAgICAgIGtleUV4aXQgPSBnZXRFeGl0RnVuY3Rpb24oa2V5SGFuZGxlcik7XG4gICAgfVxuICB9XG5cbiAgaWYgKGtleUVudGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoa2V5RW50ZXIobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHZhbHVlLCBwYXRoLCBrZXkpO1xuICB9IGVsc2Uge1xuICAgIGxldCBrZXlQYXRoID0gbmV3IFBhdGgodmFsdWUsIHBhdGgsIGtleSk7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCBrZXlQYXRoKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIFRPRE86IGR5bmFtaWNhbGx5IGNoZWNrIHRoZSByZXN1bHRzIGJ5IGhhdmluZyBhIHRhYmxlIG9mXG4gICAgICAvLyBleHBlY3RlZCBub2RlIHR5cGVzIGluIHZhbHVlIHNwYWNlLCBub3QganVzdCB0eXBlIHNwYWNlXG4gICAgICBhc3NpZ25LZXkobm9kZSwga2V5LCB2YWx1ZSwgcmVzdWx0IGFzIGFueSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGtleUV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChrZXlFeGl0KG5vZGUsIGtleSkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHZpc2l0QXJyYXkoXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBhcnJheTogQVNULk5vZGVbXSxcbiAgcGFyZW50OiBQYXRoPEFTVC5Ob2RlPiB8IG51bGwsXG4gIHBhcmVudEtleTogc3RyaW5nIHwgbnVsbFxuKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgbm9kZSA9IGFycmF5W2ldO1xuICAgIGxldCBwYXRoID0gbmV3IFBhdGgobm9kZSwgcGFyZW50LCBwYXJlbnRLZXkpO1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpICs9IHNwbGljZUFycmF5KGFycmF5LCBpLCByZXN1bHQpIC0gMTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzaWduS2V5PE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBub2RlOiBOLFxuICBrZXk6IEssXG4gIHZhbHVlOiBBU1QuTm9kZSxcbiAgcmVzdWx0OiBOW0tdIHwgW05bS11dIHwgbnVsbFxuKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICB0aHJvdyBjYW5ub3RSZW1vdmVOb2RlKHZhbHVlLCBub2RlLCBrZXkpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAxKSB7XG4gICAgICBzZXQobm9kZSwga2V5LCByZXN1bHRbMF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZW1vdmVOb2RlKHZhbHVlLCBub2RlLCBrZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU5vZGUodmFsdWUsIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHNldChub2RlLCBrZXksIHJlc3VsdCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3BsaWNlQXJyYXkoYXJyYXk6IEFTVC5Ob2RlW10sIGluZGV4OiBudW1iZXIsIHJlc3VsdDogQVNULk5vZGUgfCBBU1QuTm9kZVtdIHwgbnVsbCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIC4uLnJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGg7XG4gIH0gZWxzZSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCByZXN1bHQpO1xuICAgIHJldHVybiAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGU6IEFTVC5Ob2RlLCB2aXNpdG9yOiBOb2RlVmlzaXRvcikge1xuICBsZXQgcGF0aCA9IG5ldyBQYXRoKG5vZGUpO1xuICB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9