'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = traverse;

var _visitorKeys = require('../types/visitor-keys');

var _visitorKeys2 = _interopRequireDefault(_visitorKeys);

var _errors = require('./errors');

var _util = require('@glimmer/util');

var _path2 = require('./path');

var _path3 = _interopRequireDefault(_path2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function getEnterFunction(handler) {
    if (typeof handler === 'function') {
        return handler;
    } else {
        return handler.enter;
    }
}
function getExitFunction(handler) {
    if (typeof handler === 'function') {
        return undefined;
    } else {
        return handler.exit;
    }
}
function getKeyHandler(handler, key) {
    var keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    var keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    if (nodeType === 'Template' || nodeType === 'Block') {
        if (visitor.Program) {
            if (false) {
                false && !false && (0, _util.deprecate)('TODO');
            }
            return visitor.Program;
        }
    }
    var handler = visitor[nodeType];
    if (handler !== undefined) {
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, path) {
    var node = path.node,
        parent = path.parent,
        parentKey = path.parentKey;

    var handler = getNodeHandler(visitor, node.type);
    var enter = void 0;
    var exit = void 0;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    var result = void 0;
    if (enter !== undefined) {
        result = enter(node, path);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            visitArray(visitor, result, parent, parentKey);
            return result;
        } else {
            var _path = new _path3.default(result, parent, parentKey);
            return visitNode(visitor, _path) || result;
        }
    }
    if (result === undefined) {
        var keys = _visitorKeys2.default[node.type];
        for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, path, key);
        }
        if (exit !== undefined) {
            result = exit(node, path);
        }
    }
    return result;
}
function get(node, key) {
    return node[key];
}
function set(node, key, value) {
    node[key] = value;
}
function visitKey(visitor, handler, path, key) {
    var node = path.node;

    var value = get(node, key);
    if (!value) {
        return;
    }
    var keyEnter = void 0;
    var keyExit = void 0;
    if (handler !== undefined) {
        var keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value, path, key);
    } else {
        var keyPath = new _path3.default(value, path, key);
        var result = visitNode(visitor, keyPath);
        if (result !== undefined) {
            // TODO: dynamically check the results by having a table of
            // expected node types in value space, not just type space
            assignKey(node, key, value, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw (0, _errors.cannotReplaceOrRemoveInKeyHandlerYet)(node, key);
        }
    }
}
function visitArray(visitor, array, parent, parentKey) {
    for (var i = 0; i < array.length; i++) {
        var node = array[i];
        var path = new _path3.default(node, parent, parentKey);
        var result = visitNode(visitor, path);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, value, result) {
    if (result === null) {
        throw (0, _errors.cannotRemoveNode)(value, node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            set(node, key, result[0]);
        } else {
            if (result.length === 0) {
                throw (0, _errors.cannotRemoveNode)(value, node, key);
            } else {
                throw (0, _errors.cannotReplaceNode)(value, node, key);
            }
        }
    } else {
        set(node, key, result);
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
function traverse(node, visitor) {
    var path = new _path3.default(node);
    visitNode(visitor, path);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O2tCQW1QYyxROzs7Ozs7QUFsUGQ7O0FBTUE7O0FBR0E7Ozs7OztBQVFBLFNBQUEsZ0JBQUEsQ0FBQSxPQUFBLEVBQ2dEO0FBRTlDLFFBQUksT0FBQSxPQUFBLEtBQUosVUFBQSxFQUFtQztBQUNqQyxlQUFBLE9BQUE7QUFERixLQUFBLE1BRU87QUFDTCxlQUFPLFFBQVAsS0FBQTtBQUNEO0FBQ0Y7QUFNRCxTQUFBLGVBQUEsQ0FBQSxPQUFBLEVBQ2dEO0FBRTlDLFFBQUksT0FBQSxPQUFBLEtBQUosVUFBQSxFQUFtQztBQUNqQyxlQUFBLFNBQUE7QUFERixLQUFBLE1BRU87QUFDTCxlQUFPLFFBQVAsSUFBQTtBQUNEO0FBQ0Y7QUFFRCxTQUFBLGFBQUEsQ0FBQSxPQUFBLEVBQUEsR0FBQSxFQUVRO0FBRU4sUUFBSSxhQUFhLE9BQUEsT0FBQSxLQUFBLFVBQUEsR0FBZ0MsUUFBaEMsSUFBQSxHQUFqQixTQUFBO0FBQ0EsUUFBSSxlQUFKLFNBQUEsRUFBOEI7QUFFOUIsUUFBSSxhQUFhLFdBQWpCLEdBQWlCLENBQWpCO0FBQ0EsUUFBSSxlQUFKLFNBQUEsRUFBOEI7QUFDNUIsZUFBQSxVQUFBO0FBQ0Q7QUFDRCxXQUFPLFdBQVAsR0FBQTtBQUNEO0FBT0QsU0FBQSxjQUFBLENBQUEsT0FBQSxFQUFBLFFBQUEsRUFFcUI7QUFFbkIsUUFBSSxhQUFBLFVBQUEsSUFBMkIsYUFBL0IsT0FBQSxFQUFxRDtBQUNuRCxZQUFJLFFBQUosT0FBQSxFQUFxQjtBQUNuQixnQkFBQSxLQUFBLEVBQWE7QUFBQSx5QkFBQSxDQUFBLEtBQUEsSUFBQSxxQkFBQSxNQUFBLENBQUE7QUFFWjtBQUVELG1CQUFPLFFBQVAsT0FBQTtBQUNEO0FBQ0Y7QUFFRCxRQUFJLFVBQVUsUUFBZCxRQUFjLENBQWQ7QUFDQSxR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VmlzaXRvcktleSB9IGZyb20gJy4uL3R5cGVzL3Zpc2l0b3Ita2V5cyc7XG5pbXBvcnQge1xuICBjYW5ub3RSZW1vdmVOb2RlLFxuICBjYW5ub3RSZXBsYWNlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0LFxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IHsgZGVwcmVjYXRlIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBERVZNT0RFIH0gZnJvbSAnQGdsaW1tZXIvbG9jYWwtZGVidWctZmxhZ3MnO1xuaW1wb3J0IHsgTm9kZUhhbmRsZXIsIE5vZGVWaXNpdG9yLCBLZXlIYW5kbGVyLCBOb2RlVHJhdmVyc2FsLCBLZXlUcmF2ZXJzYWwgfSBmcm9tICcuL3Zpc2l0b3InO1xuaW1wb3J0IFBhdGggZnJvbSAnLi9wYXRoJztcblxuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IEtleVRyYXZlcnNhbDxOLCBLPlxuKTogS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gfCBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZCB7XG4gIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBoYW5kbGVyO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVyLmVudGVyIGFzIE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPjtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlPihoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+KTogTm9kZUhhbmRsZXI8Tj4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IEtleVRyYXZlcnNhbDxOLCBLPlxuKTogS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPiB8IEtleVRyYXZlcnNhbDxOLCBLPlxuKTogTm9kZUhhbmRsZXI8Tj4gfCBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkIHtcbiAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlci5leGl0IGFzIE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPjtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRLZXlIYW5kbGVyPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+LFxuICBrZXk6IEtcbik6IEtleVRyYXZlcnNhbDxOLCBLPiB8IEtleVRyYXZlcnNhbDxOLCBWaXNpdG9yS2V5PE4+PiB8IHVuZGVmaW5lZCB7XG4gIGxldCBrZXlWaXNpdG9yID0gdHlwZW9mIGhhbmRsZXIgIT09ICdmdW5jdGlvbicgPyBoYW5kbGVyLmtleXMgOiB1bmRlZmluZWQ7XG4gIGlmIChrZXlWaXNpdG9yID09PSB1bmRlZmluZWQpIHJldHVybjtcblxuICBsZXQga2V5SGFuZGxlciA9IGtleVZpc2l0b3Jba2V5XTtcbiAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBrZXlIYW5kbGVyIGFzIEtleVRyYXZlcnNhbDxOLCBLPjtcbiAgfVxuICByZXR1cm4ga2V5VmlzaXRvci5BbGw7XG59XG5cbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyPE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBub2RlVHlwZTogTlsndHlwZSddXG4pOiBOb2RlVHJhdmVyc2FsPE4+O1xuZnVuY3Rpb24gZ2V0Tm9kZUhhbmRsZXIodmlzaXRvcjogTm9kZVZpc2l0b3IsIG5vZGVUeXBlOiAnQWxsJyk6IE5vZGVUcmF2ZXJzYWw8QVNULk5vZGU+O1xuZnVuY3Rpb24gZ2V0Tm9kZUhhbmRsZXI8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIG5vZGVUeXBlOiBOWyd0eXBlJ11cbik6IE5vZGVUcmF2ZXJzYWw8Tj4gfCBOb2RlVHJhdmVyc2FsPEFTVC5Ob2RlPiB8IHVuZGVmaW5lZCB7XG4gIGlmIChub2RlVHlwZSA9PT0gJ1RlbXBsYXRlJyB8fCBub2RlVHlwZSA9PT0gJ0Jsb2NrJykge1xuICAgIGlmICh2aXNpdG9yLlByb2dyYW0pIHtcbiAgICAgIGlmIChERVZNT0RFKSB7XG4gICAgICAgIGRlcHJlY2F0ZShgVE9ET2ApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdmlzaXRvci5Qcm9ncmFtIGFzIGFueTtcbiAgICB9XG4gIH1cblxuICBsZXQgaGFuZGxlciA9IHZpc2l0b3Jbbm9kZVR5cGVdO1xuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIChoYW5kbGVyIGFzIHVua25vd24pIGFzIE5vZGVUcmF2ZXJzYWw8Tj47XG4gIH1cbiAgcmV0dXJuIHZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiB2aXNpdE5vZGU8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIHBhdGg6IFBhdGg8Tj5cbik6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkIHtcbiAgbGV0IHsgbm9kZSwgcGFyZW50LCBwYXJlbnRLZXkgfSA9IHBhdGg7XG5cbiAgbGV0IGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gPSBnZXROb2RlSGFuZGxlcih2aXNpdG9yLCBub2RlLnR5cGUpO1xuICBsZXQgZW50ZXI7XG4gIGxldCBleGl0O1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBlbnRlciA9IGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcik7XG4gICAgZXhpdCA9IGdldEV4aXRGdW5jdGlvbihoYW5kbGVyKTtcbiAgfVxuXG4gIGxldCByZXN1bHQ6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkO1xuICBpZiAoZW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlc3VsdCA9IGVudGVyKG5vZGUsIHBhdGgpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCwgcGFyZW50LCBwYXJlbnRLZXkpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhdGggPSBuZXcgUGF0aChyZXN1bHQsIHBhcmVudCwgcGFyZW50S2V5KTtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGtleSA9IGtleXNbaV0gYXMgVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE47XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIHBhdGgsIGtleSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzdWx0ID0gZXhpdChub2RlLCBwYXRoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBnZXQ8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgbm9kZTogTixcbiAga2V5OiBWaXNpdG9yS2V5c1tOWyd0eXBlJ11dICYga2V5b2YgTlxuKTogQVNULk5vZGUgfCBBU1QuTm9kZVtdIHtcbiAgcmV0dXJuIChub2RlW2tleV0gYXMgdW5rbm93bikgYXMgQVNULk5vZGUgfCBBU1QuTm9kZVtdO1xufVxuXG5mdW5jdGlvbiBzZXQ8TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMga2V5b2YgTj4obm9kZTogTiwga2V5OiBLLCB2YWx1ZTogTltLXSk6IHZvaWQge1xuICBub2RlW2tleV0gPSB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXk8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4sXG4gIHBhdGg6IFBhdGg8Tj4sXG4gIGtleTogVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE5cbikge1xuICBsZXQgeyBub2RlIH0gPSBwYXRoO1xuXG4gIGxldCB2YWx1ZSA9IGdldChub2RlLCBrZXkpO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGtleUVudGVyO1xuICBsZXQga2V5RXhpdDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleUhhbmRsZXIgPSBnZXRLZXlIYW5kbGVyKGhhbmRsZXIsIGtleSk7XG4gICAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAga2V5RW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgICAga2V5RXhpdCA9IGdldEV4aXRGdW5jdGlvbihrZXlIYW5kbGVyKTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChrZXlFbnRlcihub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUsIHBhdGgsIGtleSk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGtleVBhdGggPSBuZXcgUGF0aCh2YWx1ZSwgcGF0aCwga2V5KTtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGtleVBhdGgpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gVE9ETzogZHluYW1pY2FsbHkgY2hlY2sgdGhlIHJlc3VsdHMgYnkgaGF2aW5nIGEgdGFibGUgb2ZcbiAgICAgIC8vIGV4cGVjdGVkIG5vZGUgdHlwZXMgaW4gdmFsdWUgc3BhY2UsIG5vdCBqdXN0IHR5cGUgc3BhY2VcbiAgICAgIGFzc2lnbktleShub2RlLCBrZXksIHZhbHVlLCByZXN1bHQgYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUV4aXQobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGFycmF5OiBBU1QuTm9kZVtdLFxuICBwYXJlbnQ6IFBhdGg8QVNULk5vZGU+IHwgbnVsbCxcbiAgcGFyZW50S2V5OiBzdHJpbmcgfCBudWxsXG4pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCBub2RlID0gYXJyYXlbaV07XG4gICAgbGV0IHBhdGggPSBuZXcgUGF0aChub2RlLCBwYXJlbnQsIHBhcmVudEtleSk7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCBwYXRoKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXk8TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIG5vZGU6IE4sXG4gIGtleTogSyxcbiAgdmFsdWU6IEFTVC5Ob2RlLFxuICByZXN1bHQ6IE5bS10gfCBbTltLXV0gfCBudWxsXG4pIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUodmFsdWUsIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIHNldChub2RlLCBrZXksIHJlc3VsdFswXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUodmFsdWUsIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2V0KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheShhcnJheTogQVNULk5vZGVbXSwgaW5kZXg6IG51bWJlciwgcmVzdWx0OiBBU1QuTm9kZSB8IEFTVC5Ob2RlW10gfCBudWxsKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHJldHVybiAwO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgLi4ucmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIHJlc3VsdCk7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdHJhdmVyc2Uobm9kZTogQVNULk5vZGUsIHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIGxldCBwYXRoID0gbmV3IFBhdGgobm9kZSk7XG4gIHZpc2l0Tm9kZSh2aXNpdG9yLCBwYXRoKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=