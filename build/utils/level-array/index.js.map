{"version":3,"sources":["../../../src/utils/level-array/index.js"],"names":["LevelArray","db","lastIndex","undefined","prototype","createReadStream","createKeyStream","createValueStream","unshift","value","self","iterator","lt","reverse","Promise","res","rej","moveBackward","err","key","end","del","parseInt","toString","put","next","shift","gt","item","get","moveForward","push","_lastIndex","pop","includes","indexOf","element","callback","stream","on","data","destroy","length","index","peek","last","clear","keys","batch","map","type","_getAll","result"],"mappings":"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","sourcesContent":["import peek from 'level-peek';\nimport { appendCallback, createCallback, returnPromise } from '../versatile-function';\n\nfunction LevelArray(db) {\n  if (!(this instanceof LevelArray)) {\n    return new LevelArray(db);\n  }\n\n  this.db = db;\n  this.lastIndex = undefined;\n}\n\nLevelArray.prototype.createReadStream = function() {};\n\nLevelArray.prototype.createKeyStream = function() {};\n\nLevelArray.prototype.createValueStream = function() {};\n\nLevelArray.prototype.unshift = appendCallback(async function(value) {\n  const self = this;\n  const iterator = self.db.iterator({ lt: 'z', reverse: true });\n\n  await new Promise((res, rej) => {\n    async function moveBackward(err, key, value) {\n      if (err) return rej(err);\n      if (!key) return iterator.end(res);\n      await self.db.del(parseInt(key.toString()));\n      await self.db.put(parseInt(key.toString()) + 1, value);\n      iterator.next(moveBackward);\n    }\n\n    iterator.next(moveBackward);\n  });\n\n  await self.db.put(0, value);\n  return this.lastIndex += 1;\n});\n\nLevelArray.prototype.shift = appendCallback(async function() {\n  const self = this;\n  const iterator = self.db.iterator({ gt: 0 });\n  const item = await self.db.get(0);\n  await this.db.del(0);\n\n  await new Promise((res, rej) => {\n    async function moveForward(err, key, value) {\n      if (err) return rej(err);\n      if (!key) return iterator.end(res);\n      await self.db.del(parseInt(key.toString()));\n      await self.db.put(parseInt(key.toString()) - 1, value);\n      iterator.next(moveForward);\n    }\n\n    iterator.next(moveForward);\n  });\n\n  this.lastIndex -= 1;\n  return item;\n});\n\nLevelArray.prototype.push = appendCallback(async function(value) {\n  const lastIndex = await this._lastIndex();\n  await this.db.put(lastIndex + 1, value);\n  return this.lastIndex += 1;\n});\n\nLevelArray.prototype.pop = appendCallback(async function() {\n  const lastIndex = await this._lastIndex();\n  if (lastIndex === -1) return undefined;\n  const value = await this.db.get(lastIndex);\n  await this.db.del(lastIndex);\n  this.lastIndex -= 1;\n  return value;\n});\n\nLevelArray.prototype.includes = appendCallback(async function(value) {\n  return !!(await this.indexOf(value));\n});\n\nLevelArray.prototype.indexOf = returnPromise(1, function (element, callback) {\n  const stream = this.db.createReadStream();\n  stream.on('data', data => {\n      if (element === data.value.toString()) {\n        callback(null, parseInt(data.key.toString()));\n        stream.destroy();\n      }\n    })\n    .on('end', function () {\n      callback(null, -1);\n    })\n    .on('error', err => callback(err));\n});\n\nLevelArray.prototype.length = appendCallback(async function() {\n  const index = await this._lastIndex();\n  return index + 1;\n});\n\nLevelArray.prototype._lastIndex = appendCallback(async function() {\n  if (this.lastIndex === undefined) {\n    const index = await new Promise((res, rej) => {\n      peek.last(this.db, { end: 'z' }, (err, key) => {\n        if (err) return rej(err);\n        res(key);\n      });\n    });\n    this.lastIndex = index ? parseInt(index.toString()) : -1;\n  }\n\n  return this.lastIndex;\n});\n\nLevelArray.prototype.clear = appendCallback(async function() {\n  const keys = [];\n  await new Promise(res => this.db.createKeyStream()\n    .on('data', key => keys.push(key))\n    .on('end', () => res())\n  );\n\n  if (keys.length > 0) {\n    await this.db.batch(keys.map(key => ({ type: 'del', key })));\n    this.lastIndex = -1;\n  }\n});\n\nLevelArray.prototype._getAll = returnPromise(0, function(callback) {\n  const result = [];\n  this.db.createReadStream()\n    .on('data', data => result.push(data.value.toString()))\n    .on('end', () => callback(null, result))\n    .on('error', err => callback(err));\n});\n\n//\n// Array.prototype.join = returnPromise(1, Array.prototype.join);\n//\n// Array.prototype.splice = returnPromise((...args) => {\n//   const lastArg = args.pop();\n//   return typeof lastArg === 'function' ? createCallback(lastArg) : createCallback();\n// }, Array.prototype.splice);\n//\n// Array.prototype.indexOf = returnPromise(1, Array.prototype.indexOf);\n\nexport default LevelArray;\n"],"file":"index.js"}