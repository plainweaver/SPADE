{"version":3,"sources":["../../src/utils/level-transform.js"],"names":["module","exports","DB","default","composeFunctions","funcs","undefined","Array","isArray","composedFunction","args","reduce","acc","cur","key","value","db","options","_transformBefore","transformBefore","_transformAfter","transformAfter","_transformLtgt","transformLtgt","opts","prototype","serializeKey","data","serializeValue","open","cb","close","put","transformed","get","transformedKey","err","del","chainedBatch","Batch","batch","ops","map","op","iterator","Iterator","clear","callback","AbstractIterator","call","keys","values","_oldOpts","it","next","self","console","log","keyAsBuffer","JSON","stringify","Buffer","from","valueAsBuffer","seek","end","AbstractChainedBatch","write"],"mappings":"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","sourcesContent":["/*\n * Encoding-down for databases with optional transformation.\n */\n\nimport { AbstractLevelDOWN, AbstractIterator, AbstractChainedBatch } from 'abstract-leveldown';\nimport { inherits } from 'util';\n\nmodule.exports = DB.default = DB;\n\nfunction composeFunctions(funcs) {\n  if (!funcs) return undefined;\n  if (!Array.isArray(funcs)) return funcs;\n\n  return function composedFunction(...args) {\n    return funcs.reduce((acc, cur) => {\n      if (Array.isArray(acc)) {\n        return cur(...acc);\n      }\n\n      else {\n        return cur(acc.key, acc.value);\n      }\n    }, args);\n  };\n}\n\nfunction DB (db, options) {\n  if (!(this instanceof DB)) return new DB(db, options);\n\n  this._transformBefore = composeFunctions(options.transformBefore);\n  this._transformAfter = composeFunctions(options.transformAfter);\n  this._transformLtgt = composeFunctions(options.transformLtgt) || function(opts) { return opts };\n\n  this.db = db;\n}\n\nDB.prototype.serializeKey = function (data) { return data; };\n\nDB.prototype.serializeValue = function (data) { return data; };\n\nDB.prototype.open = function (opts, cb) {\n  return this.db.open(opts, cb)\n};\n\nDB.prototype.close = function (cb) {\n  return this.db.close(cb)\n};\n\nDB.prototype.put = function (key, value, opts, cb) {\n  const transformed = this._transformBefore(key, value);\n  return this.db.put(transformed.key, transformed.value, opts, cb)\n};\n\nDB.prototype.get = function (key, opts, cb) {\n  const transformedKey = this._transformBefore(key);\n  return this.db.get(transformedKey, opts, (err, value) => {\n    cb(null, this._transformAfter(key, value));\n  })\n};\n\nDB.prototype.del = function (key, opts, cb) {\n  const transformedKey = this._transformBefore(key);\n  return this.db.del(transformedKey, opts, cb)\n};\n\nDB.prototype.chainedBatch = function () {\n  return new Batch(this)\n};\n\nDB.prototype.batch = function (ops, opts, cb) {\n  ops = ops.map(op => {\n    const transformed = op.value ? this._transformBefore(op.key, op.value) : this._transformBefore(op.key);\n    return {\n      ...op,\n      ...transformed\n    }\n  });\n\n  return this.db.batch(ops, opts, cb);\n};\n\nDB.prototype.iterator = function (opts) {\n  return new Iterator(this, opts)\n};\n\nDB.prototype.clear = function (opts, callback) {\n  opts = this._transformLtgt(opts);\n  return this.db.clear(opts, callback);\n};\n\nfunction Iterator (db, opts) {\n  AbstractIterator.call(this, db);\n  this._transformBefore = db._transformBefore;\n  this._transformAfter = db._transformAfter;\n  this.opts = {\n    ...opts,\n    ...db._transformLtgt(opts),\n    keys: true,\n    values: true,\n  };\n\n  this._oldOpts = opts;\n\n  this.it = db.db.iterator(this.opts);\n}\n\ninherits(Iterator, AbstractIterator);\n\nIterator.prototype.next = function (cb) {\n  const self = this;\n  return this.it.next(function (err, key, value) {\n    console.log(self);\n    if (err) return cb(err);\n    const transformed = self._transformAfter(key, value);\n\n    if (!self._oldOpts.keys) {\n      transformed.key = transformed.value;\n    }\n\n    if (!self._oldOpts.value) {\n      transformed.value = transformed.key;\n    }\n\n    if (transformed.key && self._oldOpts.keyAsBuffer) {\n      if (typeof transformed.key === 'object') {\n        transformed.key = JSON.stringify(transformed.key);\n      }\n      transformed.key = Buffer.from(transformed.key);\n    }\n\n    if (transformed.value && self._oldOpts.valueAsBuffer) {\n      if (typeof transformed.value === 'object') {\n        transformed.value = JSON.stringify(transformed.key);\n      }\n      transformed.value = Buffer.from(transformed.value);\n    }\n\n    cb(null, transformed.key, transformed.value);\n  })\n};\n\nIterator.prototype.seek = function (key) {\n  return this.it.seek(key);\n};\n\nIterator.prototype.end = function (cb) {\n  return this.it.end(cb)\n};\n\nfunction Batch (db) {\n  AbstractChainedBatch.call(this, db);\n  this.batch = db.db.batch()\n}\n\ninherits(Batch, AbstractChainedBatch);\n\nBatch.prototype.put = function (key, value) {\n  const transformed = this._transformBefore(key, value);\n  return this.batch.put(transformed.key, transformed.value)\n};\n\nBatch.prototype.del = function (key) {\n  key = this._transformBefore(key);\n  return this.batch.del(key)\n};\n\nBatch.prototype.clear = function () {\n  return this.batch.clear()\n};\n\nBatch.prototype.write = function (opts, cb) {\n  return this.batch.write(opts, cb)\n};"],"file":"level-transform.js"}